---
- debug:
    var: share

- name: test share.path
  stat:
    path: '{{ share.path }}'
  register: path_stat

# create
- block:
  # need mkdir
  - name: zfs create
    zfs:
      name: '{{ share.zfsrc }}'
      mountpoint: '{{ share.path }}'
      state: present
    register: zfsshare
    when: '"zfsrc" in share'
  - name: mkdir
    file:
      path: '{{ share.path }}'
      state: directory
    when: '"zfsrc" not in share'
  when: not path_stat.stat.exists

- name: nfs export
  blockinfile:
    path: /etc/exports
    marker: '# { mark } ANSIBLE MANAGED BLOCK {{ share.path }}'
    block: |
      {% for ex in share.nfsshares %}
      {{ share.path }} {{ ex }}
      {% endfor %}

