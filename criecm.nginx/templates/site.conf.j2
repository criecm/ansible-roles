{% if nginx_site.tls_redirect and not proxified_by %}
server {
	listen 80;
	server_name	{{ nginx_site.name }}{% if nginx_site.aliases | count > 0 %} {{ nginx_site.aliases | join(" ") }}{% endif %};
	redirect permanent / https://{{ nginx_site.name }}/;
}
{% endif %}

{% if nginx_site.listen %}
server {
{% if proxified_by %}
	listen 80;
{% else %}
	listen	{{ nginx_site.listen }}{% if nginx_site.x509_cert %} ssl{% endif %};
{% if nginx_site.x509_cert %}
	ssl_certificate {{ tls_certs_dir }}/{{ nginx_site.x509_cert | regex_replace(".*/","") }};
	ssl_certificate_key {{ tls_certs_dir }}/private/{{ nginx_site.x509_key | regex_replace(".*/","") }};
{% if nginx_site.x509_stapling_chain %}
	ssl_trusted_certificate {{ tls_certs_dir }}/{{ nginx_site.name }}_stapling.pem;
	ssl_stapling    on;
	ssl_stapling_verify     on;
{% if nginx_site.tls_hsts | default(31536000) > 0 %}
	add_header Strict-Transport-Security "max-age={{ nginx_site.tls_hsts | default(31536000) }}";
{% endif %}
{% endif %}
{% endif %}
{% endif %}

{% if nginx_site.upload_max_meg | default(False) %}
	client_max_body_size {{ ( nginx_site.upload_max_meg * 1.3 ) | int }}m;
{% endif %}

{% if proxified_by %}
{% for net in proxified_by %}
	set_real_ip_from {{ net }};
{% endfor %}
	real_ip_header X-Forwarded-For;
{% endif %}

	server_name	{{ nginx_site.name }}{% if nginx_site.aliases %} {{ nginx_site.aliases | join(" ") }}{% endif %};
{% if not nginx_site.nginx_includes %}
	location / {
		root	{{ nginx_site.rootdir }};
		index	index.html index.htm;
	}
{% endif %}

{% include "status.inc.j2" %}

{% for inc in nginx_site.nginx_includes %}
	include {{ inc }};
{% endfor %}

	error_page	500 502 503 504	/50x.html;
}
{% endif %}
