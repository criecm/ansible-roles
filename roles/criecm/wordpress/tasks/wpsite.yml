---
- name: site vars
  include_vars: wpsite.yml

- name: site fact
  set_fact:
    wpsite: '{{ default_wp_site | combine(onewpsite) }}'

- name: configure wp cli
  block:
    - name: dir
      file:
        path: '~{{ wpsite.maintainer }}/.wp-cli'
        state: directory
      become: yes
      become_method: su
      become_user: '{{ wpsite.maintainer }}'
    - name: config
      copy:
        dest: '~{{ wpsite.maintainer }}/.wp-cli/config.yml'
        mode: '0640'
        content: |
          # ansible generated criecm.wordpress - one time only
          color: False
          url: https://{{ wpsite.name }}
          user: {{ wpsite.admin }}
          path: {{ wpsite.rootdir }}
          {% if "wp-cassify" in wpsite.wp_plugins %}
          skip-plugins:
            - wp-cassify
          {% endif %}
        force: yes
      become: yes
      become_method: su
      become_user: '{{ wpsite.maintainer }}'
    - name: user .profile
      lineinfile:
        dest: '~{{ wpsite.maintainer }}/.profile'
        line: 'export {{ item.key }}="{{ item.value }}"'
        regexp: '^export {{ item.key }}='
      with_dict:
        SERVER_NAME: '{{ wpsite.name }}'
        SERVER_PORT: '443'
        HTTPS: 'On'

- name: Download Wordpress
  shell: 'wp core download --locale={{ wp_lang }} --version={{ wp_version }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  args:
    creates: "{{ wpsite.rootdir }}/index.php"

- name: configure wordpress
  command: 'wp core config --dbhost={{ wpsite.db.host }} --dbuser={{ wpsite.db.user }} --dbpass={{ wpsite.db.pass }} --dbname={{ wpsite.db.name }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  args:
    creates: '{{ wpsite.rootdir }}/wp-config.php'

- name: chown/mod
  file:
    path: '{{ wpsite.rootdir }}/wp-content/{{ item }}'
    mode: 'u=rwX,g=rwX,o=rX'
    recurse: yes
    owner: '{{ wpsite.maintainer }}'
    group: '_{{ wpsite.id }}'
    state: directory
  loop:
    - uploads
    - cache

- name: chmod wp-content
  file:
    path: '{{ wpsite.rootdir }}/wp-content'
    mode: '2751'
    owner: '{{ wpsite.maintainer }}'
    group: '_{{ wpsite.id }}'
    state: directory

- name: create wp-cache-config.php
  copy:
    dest: '{{ wpsite.rootdir }}/wp-content/wp-cache-config.php'
    mode: '0660'
    owner: '{{ wpsite.maintainer }}'
    group: '_{{ wpsite.id }}'
    force: no
    content: '<?php'

- name: get install status
  command: 'wp core is-installed'
  ignore_errors: True
  changed_when: False
  register: isinstalled
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  
- name: configure site
  command: 'wp core install --title={{ wpsite.title | default("Titre Ã  changer") | quote }} --admin_user={{ wpsite.admin | quote }} --admin_email={{ wpsite.adminmail | quote }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  when: isinstalled.rc > 0

- name: get wp config
  command: 'wp config list --format=csv'
  register: wpconfig
  changed_when: False
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'

- name: set wp config
  command: 'wp config set {{ item }} {{ wpsite.wp_config[item] }} --type=constant'
  loop: '{{ wpsite.wp_config.keys() | list }}'
  when: wpconfig.stdout_lines | select("match",item+","+wpsite.wp_config[item] | string) | count == 0
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'

- name: list installed languages
  command: 'wp language core list --format=json'
  changed_when: False
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  register: installedlangs
  
- name: install lang {{ wp_lang }}
  command: 'wp language core install {{ wp_lang }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  when: wp_lang in installedlangs.stdout | from_json | selectattr("status","equalto","uninstalled") | map(attribute="language")

- name: activate {{ wp_lang }}
  command: 'wp language core activate {{ wp_lang }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  when: wp_lang not in installedlangs.stdout | from_json | selectattr("status","equalto","active") | map(attribute="language")

- name: list installed plugins
  command: 'wp plugin list --format=json'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  register: pluginlist
  changed_when: False

- name: Install default plugins
  command: 'wp plugin install {{ item }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  loop: "{{ wpsite.wp_plugins }}"
  when: item not in pluginlist.stdout | from_json | map(attribute="name") | list

- name: activate plugins
  command: 'wp plugin activate {{ item }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  loop: "{{ wpsite.wp_activate_plugins }}"
  when: item not in pluginlist.stdout | from_json | selectattr("status","equalto","active") | map(attribute="name") | list

- name: list installed themes
  command: 'wp theme list --format=json'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  register: themelist
  changed_when: False

- name: install theme(s)
  shell: 'wp theme install {{ item }}'
  changed_when: false
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  loop: "{{ wpsite.wp_themes }}"
  when: item not in themelist.stdout | from_json | map(attribute="name") | list

- name: activate theme
  command: 'wp theme activate {{ wp_themes[0] }}'
  become: yes
  become_method: su
  become_user: '{{ wpsite.maintainer }}'
  loop: "{{ wpsite.wp_themes }}"
  when: wp_themes | count() > 0 and themelist.stdout | from_json | selectattr("status","equalto","active") | map(attribute="name") | list | first != wp_themes[0]

- name: cron mailto
  cron:
    env: yes
    name: MAILTO
    value: '{{ wpsite.adminmail }}'
    user: '_{{ wpsite.id }}'
  when: wpsite.adminmail != ""

- name: install cron
  cron:
    name: 'cron WordPress'
    job: '/usr/local/bin/wp --path={{ wpsite.rootdir }} cron event run --due-now --quiet --skip-plugins=wp-cassify 2>&1 | grep -v Deprecated'
    user: '_{{ wpsite.id }}'
    minute: '*/30'

- name: auto-update by cron
  block:
    - name: update script
      copy:
        dest: '{{ wpsite.home }}/update_wp.sh'
        content: |
          #!/bin/sh
          # script MAJ wordpress {{ wpsite.id }}
          PATH="/bin:/usr/bin:/usr/local/bin"
          cd {{ wpsite.rootdir }}
          date
          wp core upgrade --minor --quiet
          wp core update-db --quiet
          wp plugin list --format=csv | awk 'BEGIN{FS=","}{if(($1!="name")&&($3!="none")){printf("%s %s: update %s\n",$1,$4,$3);}}'
          wp plugin update --all --format=csv | awk 'BEGIN{FS=","}{if($0~/pdated/){printf("%s %s -> %s\n",$1,$2,$3);}}'
          wp theme list --format=csv | awk 'BEGIN{FS=","}{if(($1!="name")&&($3!="none")){printf("%s %s: update %s\n",$1,$4,$3);}}'
          wp theme update --all --format=csv | awk 'BEGIN{FS=","}{if($0~/pdated/){printf("%s %s -> %s\n",$1,$2,$3);}}'
          wp core update-db --quiet
          wp language core update
          wp language plugin update --all
          wp language theme update --all
    
        mode: '0500'
        owner: '{{ wpsite.maintainer }}'
    
    - name: cron mailto
      cron:
        env: yes
        name: MAILTO
        value: '{{ wpsite.adminmail }}'
        user: '{{ wpsite.maintainer }}'
      when: wpsite.adminmail != ""

    - name: cron MAJ wp
      cron:
        name: 'MAJ wordpress'
        job: '{{ wpsite.home }}/update_wp.sh | tee -a ~/update.log 2>&1'
        user: '{{ wpsite.maintainer }}'
        dow: '3'
        minute: '33'
        hour: '0'
  when: wp_update_cron | default(True)

- name: update now
  block:
    - name: Check if Wordpress is up to date
      shell: 'wp core check-update | grep -q Success'
      register: check_version
      check_mode: no
      failed_when: false
      changed_when: check_version.rc

    - name: Update Wordpress
      shell: 'wp core update --version={{ wp_version }}'
      become: yes
      become_method: su
      become_user: '{{ wpsite.maintainer }}'
      when: check_version.rc

    - name: update theme(s)
      command: 'wp theme update --all --format=json'
      become: yes
      become_method: su
      become_user: '{{ wpsite.maintainer }}'

    - name: Update default plugins
      shell: 'wp plugin is-installed {{ item }} && wp plugin update {{ item }}'
      changed_when: false
      become: yes
      become_method: su
      become_user: '{{ wpsite.maintainer }}'
      with_items: "{{ wp_plugins }}"

    - name: Activate default plugins
      shell: 'wp plugin is-installed {{ item }} && wp plugin activate {{ item }}'
      changed_when: false
      become: yes
      become_method: su
      become_user: '{{ wpsite.maintainer }}'
      with_items: "{{ wp_plugins }}"
  when: wp_do_update | default(False)
